
datasource db {
  provider  = "postgresql"
  url  	    = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  EMPLOYEE
  MANAGER  // Limited admin: can view employees, events, and conference rooms
  ADMIN    // Full admin access
}

enum ContributionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum EventType {
  BIRTHDAY
  FUNERAL
  CHILDBIRTH
  MARRIAGE
  OTHER
  TEAM_BUILDING
  TRAINING
  MEETING
  WORKSHOP
  CONFERENCE
  TOWN_HALL
  CELEBRATION
}

enum EventCategory {
  WELFARE    // Welfare events (birthdays, funerals, etc.)
  COMPANY    // Company events (meetings, training, etc.)
}

enum EventStatus {
  ACTIVE
  ARCHIVED
}

enum AttendeeStatus {
  PENDING
  ACCEPTED
  DECLINED
  MAYBE
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ExpenseType {
  BIRTHDAY
  FUNERAL
  MARRIAGE
  CHILDBIRTH
  EMPLOYEE_DEPARTURE
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  EVENT_UPCOMING       // Event happening soon
  EVENT_ACTIVE         // Event is currently active
  EVENT_CREATED        // New event created
  CONTRIBUTION_ADDED   // New contribution recorded
  EXPENSE_ADDED        // New expense recorded
  REMINDER             // General reminder to check the app
  ANNOUNCEMENT         // General announcement
  ROOM_BOOKING_CREATED // Conference room booking notification
  ROOM_BOOKING_PENDING // Conference room booking pending approval (for approvers)
  ROOM_BOOKING_APPROVED // Conference room booking approved (for requester)
  ROOM_BOOKING_REJECTED // Conference room booking rejected (for requester)
}

// ============================================
// MODELS
// ============================================

model User {
  id                    String                  @id @default(cuid())
  email                 String                  @unique
  name                  String
  department            String?
  password              String                  @default("")
  role                  UserRole                @default(EMPLOYEE)
  isActive              Boolean                 @default(true) // Track if employee is active or has resigned
  isContributor         Boolean                 @default(true) // Track if employee contributes to the welfare fund
  canApproveBookings    Boolean                 @default(false) // Permission to approve/reject conference room bookings
  dateOfBirth           DateTime?               // Birthday for automatic birthday tracking
  contributions         Contribution[]
  events                Event[]
  expenses              Expense[]
  notifications         Notification[]
  eventAttendees        EventAttendee[]
  conferenceRoomBookings ConferenceRoomBooking[]
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @default(now())

  emailVerified Boolean
  image         String?
  sessions      Session[]
  accounts      Account[]

  @@map("users")
}

model Contribution {
  id        String             @id @default(cuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id])
  amount    Float
  month     DateTime
  year      Int
  quarter   Int
  status    ContributionStatus @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @default(now())
  // Indexes for faster aggregation
  @@index([userId, year, month])
  @@index([year, quarter])
  @@map("contributions")
}

model Event {
  id                    String         @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id])
  type                  EventType
  category              EventCategory @default(WELFARE) // Differentiate between welfare and company events
  title                 String
  start                 DateTime
  end                   DateTime
  year                  Int
  month                 Int
  quarter               Int
  description           String?
  location              String?
  status                EventStatus @default(ACTIVE)
  emailNotificationSent Boolean     @default(false) // Track if notification email was sent
  maxAttendees          Int?        // For company events with limited capacity
  isRecurring           Boolean     @default(false) // Support for recurring events
  recurrencePattern     String?     // JSON string: {frequency: 'daily'|'weekly'|'monthly', interval: number, endDate: Date}
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @default(now())
  attendees             EventAttendee[]
  // Indexes for faster querying and aggregation
  @@index([type, year, month])
  @@index([year, quarter])
  @@index([category, status])
  @@map("events")
}

model EventAttendee {
  id          String            @id @default(cuid())
  eventId     String
  event       Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId      String
  user        User              @relation(fields: [userId], references: [id])
  status      AttendeeStatus    @default(PENDING)
  respondedAt DateTime?
  createdAt   DateTime          @default(now())

  @@unique([eventId, userId])
  @@index([userId, status])
  @@map("event_attendees")
}

model ConferenceRoom {
  id          String              @id @default(cuid())
  name        String              @unique
  capacity    Int
  location    String?
  amenities   String?             // JSON array: ['Projector', 'Whiteboard', 'Video Conference']
  isActive    Boolean             @default(true)
  description String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @default(now())
  bookings    ConferenceRoomBooking[]

  @@map("conference_rooms")
}

model ConferenceRoomBooking {
  id              String          @id @default(cuid())
  roomId          String
  room            ConferenceRoom  @relation(fields: [roomId], references: [id])
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  title           String
  description     String?
  start           DateTime
  end             DateTime
  status          BookingStatus   @default(PENDING) // Requires approver approval
  purpose         String?
  attendeeCount   Int?
  rejectionReason String?         // Reason for rejection if status is REJECTED
  approvedBy      String?         // User ID of approver who approved/rejected
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now())

  @@index([roomId, start, end])
  @@index([userId, status])
  @@index([start, end, status])
  @@map("conference_room_bookings")
}

model Expense {
  id          Int           @id @default(autoincrement())
  type        ExpenseType
  amount      Float
  date        DateTime
  recipient   String
  description String?
  approvedBy  String? // Admin who approved the expense
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now())
  status      ExpenseStatus @default(APPROVED)
  userId      String? // Optional link to related user
  user        User?         @relation(fields: [userId], references: [id])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Policy {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique // URL-friendly identifier
  content     String   @db.Text // Store HTML or Markdown content
  version     Int      @default(1)
  isActive    Boolean  @default(true)
  updatedBy   String? // Email of admin who updated
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("policies")
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String
  linkUrl     String?          // Optional link to relevant page
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())

  // Optional references to related entities
  eventId     String?
  contributionId String?
  expenseId   Int?

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}
